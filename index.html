<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Chat_With_Us ğŸ’¬</title>
  <link rel="icon" type="image/png" href="https://i.postimg.cc/XvjGnHCY/whatsapp_xxl.png">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, sans-serif;
    }
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(145deg, #0b1f3a, #1e4b6e);
      direction: rtl;
    }
    .container {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px;
    }
    .card {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(20, 40, 60, 0.4);
      backdrop-filter: blur(18px);
      border-radius: 32px;
      border: 1px solid rgba(255,255,255,0.15);
      overflow: hidden;
    }
    .header {
      padding: 18px 20px;
      text-align: center;
      color: white;
      font-weight: 700;
      font-size: 1.4rem;
      background: rgba(0, 30, 60, 0.5);
      position: relative;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .online-btn {
      position: absolute;
      right: 16px;
      top: 12px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 40px;
      padding: 8px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10;
    }
    .green-dot {
      width: 10px;
      height: 10px;
      background: #a0ffa0;
      border-radius: 50%;
      animation: pulse 1.8s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }
    .online-panel {
      position: absolute;
      top: 70px;
      right: 16px;
      width: 280px;
      max-height: 400px;
      overflow-y: auto;
      background: rgba(10, 25, 40, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 15px;
      color: white;
      z-index: 100;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
      display: none;
    }
    .online-panel.show {
      display: block;
    }
    .online-panel h4 {
      margin: 0 0 15px 0;
      text-align: center;
      color: #f1c40f;
      border-bottom: 1px solid #34495e;
      padding-bottom: 8px;
    }
    .online-user {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 50px;
      cursor: pointer;
      transition: 0.2s;
      margin-bottom: 5px;
      border: 1px solid transparent;
    }
    .online-user:hover {
      background: rgba(52, 152, 219, 0.3);
      border-color: #3498db;
    }
    .online-user .status {
      width: 10px;
      height: 10px;
      background: #2ecc71;
      border-radius: 50%;
    }
    .online-user .name {
      flex: 1;
    }
    .private-page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(145deg, #1a0b2e, #2d1a44);
      z-index: 1000;
      display: none;
      flex-direction: column;
    }
    .private-page.show {
      display: flex;
    }
    .private-header {
      background: #6a0dad;
      padding: 15px 20px;
      color: white;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .private-header button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 1.5rem;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .private-header button:hover {
      background: rgba(255,255,255,0.3);
    }
    .private-header h3 {
      flex: 1;
      margin: 0;
    }
    .private-status {
      background: rgba(0,200,0,0.3);
      padding: 5px 15px;
      border-radius: 30px;
    }
    .private-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: rgba(20, 10, 30, 0.9);
    }
    .private-msg {
      max-width: 75%;
      padding: 12px 18px;
      border-radius: 18px 18px 18px 5px;
      background: rgba(147, 112, 219, 0.2);
      border: 2px solid #9b59b6;
      color: white;
      display: flex;
      flex-direction: column;
    }
    .private-msg.own {
      align-self: flex-end;
      background: rgba(155, 89, 182, 0.4);
      border-color: #dda0dd;
      border-radius: 18px 18px 5px 18px;
    }
    .private-msg .sender {
      color: #dda0dd;
      font-size: 0.8rem;
      margin-bottom: 5px;
    }
    .private-msg .text {
      word-break: break-word;
    }
    .private-msg .time {
      font-size: 0.7rem;
      opacity: 0.7;
      align-self: flex-end;
      margin-top: 5px;
    }
    .private-input {
      display: flex;
      gap: 10px;
      padding: 15px 20px;
      background: rgba(0,0,0,0.5);
      border-top: 2px solid #9b59b6;
    }
    .private-input input {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 30px;
      background: rgba(255,255,255,0.15);
      color: white;
      border: 2px solid #9b59b6;
    }
    .private-input input:focus {
      outline: none;
      border-color: #dda0dd;
    }
    .private-input button {
      background: #9b59b6;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 30px;
      font-weight: bold;
      cursor: pointer;
    }
    .private-input button:hover {
      background: #8e44ad;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      max-width: 75%;
      padding: 12px 18px;
      border-radius: 18px 18px 18px 5px;
      color: white;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .msg.own {
      align-self: flex-end;
      background: rgba(52, 152, 219, 0.7) !important;
      border-radius: 18px 18px 5px 18px;
    }
    .msg .sender {
      font-size: 0.8rem;
      margin-bottom: 5px;
      opacity: 0.9;
    }
    .msg .text {
      word-break: break-word;
    }
    .msg .time {
      font-size: 0.7rem;
      opacity: 0.7;
      align-self: flex-end;
      margin-top: 5px;
    }
    
    /* Ø£Ù†Ù…Ø§Ø· Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± - Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© */
    .image-upload-container {
      position: relative;
      display: inline-block;
      margin-left: 10px;
    }
    
    .image-upload-btn {
      background: #9b59b6;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
    }
    
    .image-upload-btn:hover {
      background: #8e44ad;
      transform: scale(1.05);
    }
    
    .image-preview-container {
      position: fixed;
      bottom: 100px;
      right: 20px;
      background: rgba(0,0,0,0.9);
      border-radius: 15px;
      padding: 10px;
      border: 2px solid #9b59b6;
      display: none;
      z-index: 2000;
      max-width: 300px;
    }
    
    .image-preview-container.show {
      display: block;
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 250px; /* Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© */
      border-radius: 10px;
      object-fit: contain;
    }
    
    .preview-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      justify-content: center;
    }
    
    .preview-actions button {
      padding: 8px 15px;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      width: auto;
    }
    
    .send-image-btn {
      background: #2ecc71;
      color: white;
    }
    
    .cancel-image-btn {
      background: #e74c3c;
      color: white;
    }
    
    /* ===== Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ù†Ø§ ===== */
    .image-message {
      max-width: 250px;      /* Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
      max-height: 200px;     /* Ø§Ø±ØªÙØ§Ø¹ Ù…Ù†Ø§Ø³Ø¨ */
      width: auto;           /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø© */
      height: auto;          /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø© */
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
      object-fit: contain;   /* Ù…Ù†Ø¹ ØªØ´ÙˆÙŠÙ‡ Ø§Ù„ØµÙˆØ±Ø© */
      margin-top: 5px;
      border: 2px solid rgba(255,255,255,0.1);
      background-color: rgba(0,0,0,0.2); /* Ø®Ù„ÙÙŠØ© Ù„Ù„ØµÙˆØ± Ø§Ù„Ø´ÙØ§ÙØ© */
    }
    
    .image-message:hover {
      opacity: 0.9;
      transform: scale(1.02);
      border-color: #9b59b6;
    }
    /* ============================= */
    
    .full-image-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 3000;
      display: none;
      justify-content: center;
      align-items: center;
    }
    
    .full-image-modal.show {
      display: flex;
    }
    
    .full-image-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(255,255,255,0.2);
    }
    
    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      z-index: 3001;
    }
    
    .close-modal:hover {
      background: #c0392b;
    }
    
    .upload-progress {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      padding: 20px;
      border-radius: 15px;
      color: white;
      text-align: center;
      z-index: 2500;
      display: none;
    }
    
    .upload-progress.show {
      display: block;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #9b59b6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .input-area {
      display: flex;
      gap: 10px;
      padding: 15px 20px;
      background: rgba(0,0,0,0.2);
      align-items: center;
    }
    
    .input-area input {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 30px;
      background: rgba(255,255,255,0.15);
      color: white;
    }
    
    .input-area input:focus {
      outline: none;
      background: rgba(255,255,255,0.25);
    }
    
    button {
      padding: 12px 25px;
      border: none;
      border-radius: 30px;
      font-weight: bold;
      cursor: pointer;
      background: #3498db;
      color: white;
      transition: 0.2s;
    }
    
    button:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }
    
    .logout-btn {
      position: absolute;
      left: 16px;
      top: 12px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 40px;
      padding: 8px 20px;
      width: auto;
    }
    
    .logout-btn:hover {
      background: #c0392b;
    }
    
    #auth {
      display: none;
    }
    
    #chat {
      display: none;
    }
    
    #auth input {
      width: 100%;
      padding: 15px;
      margin: 8px 0;
      border-radius: 10px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
    }
    
    #auth input.error {
      border: 2px solid #e74c3c;
      background: rgba(231, 76, 60, 0.2);
    }
    
    #auth input.valid {
      border: 2px solid #2ecc71;
      background: rgba(46, 204, 113, 0.1);
    }
    
    #auth button {
      width: 100%;
      padding: 15px;
      margin: 5px 0;
      border-radius: 10px;
      font-weight: bold;
    }
    
    #auth button:first-of-type {
      background: #2ecc71;
    }
    
    #auth button:first-of-type:hover {
      background: #27ae60;
    }
    
    #auth button:last-of-type {
      background: #3498db;
    }
    
    #auth button:last-of-type:hover {
      background: #2980b9;
    }
    
    .google-btn {
      background: #db4437 !important;
      color: white !important;
      margin-top: 10px !important;
    }
    
    .google-btn:hover {
      background: #c53929 !important;
    }
    
    .separator {
      text-align: center;
      color: white;
      margin: 15px 0;
      position: relative;
    }
    
    .separator::before,
    .separator::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 45%;
      height: 1px;
      background: rgba(255,255,255,0.3);
    }
    
    .separator::before {
      left: 0;
    }
    
    .separator::after {
      right: 0;
    }
    
    .validation-message {
      font-size: 0.8rem;
      margin-top: -5px;
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 5px;
      display: none;
    }
    
    .validation-message.error {
      display: block;
      color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }
    
    .validation-message.success {
      display: block;
      color: #2ecc71;
      background: rgba(46, 204, 113, 0.1);
    }
    
    .verification-box {
      background: rgba(241, 196, 15, 0.2);
      border: 2px solid #f1c40f;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      color: white;
      text-align: center;
      display: none;
    }
    
    .verification-box.show {
      display: block;
    }
    
    .verification-box button {
      background: #f1c40f;
      color: #2c3e50;
      margin-top: 10px;
      width: auto;
      padding: 10px 20px;
    }
    
    .resend-btn {
      background: #3498db !important;
      color: white !important;
      margin-top: 5px !important;
    }
    
    .auto-check-indicator {
      font-size: 0.8rem;
      color: #f1c40f;
      margin-top: 5px;
      animation: blink 1.5s infinite;
    }
    
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Ø£Ù†Ù…Ø§Ø· Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .loader-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(145deg, #0b1f3a, #1e4b6e);
      z-index: 10000;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .loader-container.hidden {
      opacity: 0;
      visibility: hidden;
    }
    .loader {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255,255,255,0.2);
      border-top: 6px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .loader-text {
      color: white;
      margin-top: 20px;
      font-size: 1.2rem;
      font-weight: 500;
      text-align: center;
    }
  </style>
</head>
<body>
<!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div class="loader-container" id="loader">
  <div style="display: flex; flex-direction: column; align-items: center;">
    <div class="loader"></div>
    <div class="loader-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </div>
</div>

<div class="container">
  <!-- ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
  <div class="card" id="auth">
    <div class="header">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <div style="padding: 30px;">
      <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <input id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" oninput="validateEmail()">
      <div id="emailValidation" class="validation-message"></div>
      <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      
      <!-- ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ -->
      <div id="verificationBox" class="verification-box">
        <p>ğŸ“§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</p>
        <p style="font-size:0.9rem; opacity:0.8;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ</p>
        <div class="auto-check-indicator" id="autoCheckIndicator">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...</div>
        <button onclick="checkEmailVerification()">âœ… ØªØ­Ù‚Ù‚ ÙŠØ¯ÙˆÙŠØ§Ù‹</button>
        <button class="resend-btn" onclick="resendVerification()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
      </div>
      
      <button onclick="register()">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
      <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
      
      <div class="separator">Ø£Ùˆ</div>
      
      <button class="google-btn" onclick="googleLogin()">
        <svg style="width:20px; height:20px; vertical-align:middle; margin-left:8px;" viewBox="0 0 24 24">
          <path fill="white" d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/>
        </svg>
        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google
      </button>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© -->
  <div class="card" id="chat">
    <div class="header">
      ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
      <button class="online-btn" onclick="toggleOnlinePanel()">
        <span class="green-dot"></span> Ø§Ù„Ù…ØªØµÙ„ÙˆÙ†
      </button>
      <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† -->
    <div class="online-panel" id="onlinePanel">
      <h4>Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†</h4>
      <div id="onlineList"></div>
    </div>

    <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <div id="messages"></div>

    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø¹ Ø²Ø± Ø§Ù„ØµÙˆØ± -->
    <div class="input-area">
      <input id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
      <div class="image-upload-container" id="imageUploadContainer"></div>
      <button onclick="sendPublicMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© -->
<div class="private-page" id="privatePage">
  <div class="private-header">
    <button onclick="closePrivateChat()">â†</button>
    <h3>Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹: <span id="privatePartnerName"></span></h3>
    <span class="private-status" id="privateStatus">Ù…ØªØµÙ„</span>
  </div>
  <div class="private-messages" id="privateMessages"></div>
  <div class="private-input">
    <input id="privateInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©...">
    <div class="image-upload-container" id="privateImageUploadContainer"></div>
    <button onclick="sendPrivateMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<!-- Ø¹Ù†Ø§ØµØ± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± -->
<div class="image-preview-container" id="imagePreviewContainer">
  <img id="imagePreview" class="image-preview" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
  <div class="preview-actions">
    <button class="send-image-btn" onclick="sendImageMessage()">âœ“ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©</button>
    <button class="cancel-image-btn" onclick="cancelImageUpload()">âœ— Ø¥Ù„ØºØ§Ø¡</button>
  </div>
</div>

<div class="upload-progress" id="uploadProgress">
  <div>Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...</div>
  <div class="spinner"></div>
</div>

<div class="full-image-modal" id="fullImageModal">
  <button class="close-modal" onclick="document.getElementById('fullImageModal').classList.remove('show')">âœ•</button>
  <img id="fullImage" src="" alt="">
</div>

<script>
  // âœ… ØªÙ‡ÙŠØ¦Ø© Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCn_pzKeNb5qQZyL-1Fh4WKOELhAtW4y0s",
    authDomain: "new-app-94d99.firebaseapp.com",
    projectId: "new-app-94d99",
    storageBucket: "new-app-94d99.firebasestorage.app",
    messagingSenderId: "19648456303",
    appId: "1:19648456303:web:c1383bbf4a3d5bcadc4f9a"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // âœ… ØªÙØ¹ÙŠÙ„ Google Sign-In
  const googleProvider = new firebase.auth.GoogleAuthProvider();

  // âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Cloudinary
  const CLOUD_NAME = "dn0knjzpi";
  const UPLOAD_PRESET = "chat-app";

  // âœ… Ø§Ù„Ø¹Ù†Ø§ØµØ±
  const loader = document.getElementById('loader');
  const authDiv = document.getElementById('auth');
  const chatDiv = document.getElementById('chat');
  const email = document.getElementById('email');
  const password = document.getElementById('password');
  const username = document.getElementById('username');
  const messagesDiv = document.getElementById('messages');
  const messageInput = document.getElementById('messageInput');
  const onlinePanel = document.getElementById('onlinePanel');
  const onlineList = document.getElementById('onlineList');
  const emailValidation = document.getElementById('emailValidation');
  const verificationBox = document.getElementById('verificationBox');
  const autoCheckIndicator = document.getElementById('autoCheckIndicator');
  
  const privatePage = document.getElementById('privatePage');
  const privateMessages = document.getElementById('privateMessages');
  const privateInput = document.getElementById('privateInput');
  const privatePartnerName = document.getElementById('privatePartnerName');
  const privateStatus = document.getElementById('privateStatus');

  // âœ… Ù…ØªØºÙŠØ±Ø§Øª Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
  let selectedImageFile = null;
  let imagePreviewUrl = null;
  let currentImageMessageContext = null;
  
  // âœ… Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©
  let currentUser = null;
  let currentUsername = '';
  let unsubscribePublic = null;
  let unsubscribePrivate = null;
  let unsubscribeOnline = null;
  let unsubscribePartner = null;
  let activePartner = null;
  let verificationCheckInterval = null;
  let isVerificationChecked = false;
  
  // âœ… Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  const userColors = {};

  // ===== Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ =====
  window.validateEmail = function() {
    const emailVal = email.value.trim();
    
    if (!emailVal) {
      email.classList.remove('valid', 'error');
      emailValidation.classList.remove('error', 'success');
      emailValidation.style.display = 'none';
      return false;
    }
    
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    const isValid = emailRegex.test(emailVal);
    
    if (!isValid) {
      email.classList.add('error');
      email.classList.remove('valid');
      emailValidation.classList.add('error');
      emailValidation.classList.remove('success');
      emailValidation.innerHTML = 'âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
      emailValidation.style.display = 'block';
      return false;
    } else {
      email.classList.add('valid');
      email.classList.remove('error');
      emailValidation.classList.add('success');
      emailValidation.classList.remove('error');
      emailValidation.innerHTML = 'âœ… Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ§Ù„Ø­';
      emailValidation.style.display = 'block';
      return true;
    }
  };

  // ===== Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ =====
  function sendVerificationEmail() {
    if (auth.currentUser) {
      auth.currentUser.sendEmailVerification()
        .then(() => {
          console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚');
          verificationBox.classList.add('show');
          startAutoVerificationCheck();
        })
        .catch(err => {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚:', err);
          alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø§Ù„ØªØ­Ù‚Ù‚: ' + err.message);
        });
    }
  }

  // ===== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ =====
  function startAutoVerificationCheck() {
    if (verificationCheckInterval) {
      clearInterval(verificationCheckInterval);
    }
    
    isVerificationChecked = false;
    autoCheckIndicator.style.display = 'block';
    
    verificationCheckInterval = setInterval(() => {
      if (auth.currentUser && !isVerificationChecked) {
        auth.currentUser.reload()
          .then(() => {
            if (auth.currentUser.emailVerified) {
              console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!');
              isVerificationChecked = true;
              clearInterval(verificationCheckInterval);
              autoCheckIndicator.style.display = 'none';
              
              db.collection('users').doc(auth.currentUser.uid).update({
                emailVerified: true,
                online: true
              });
            }
          })
          .catch(err => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚:', err);
          });
      }
    }, 2000);
  }

  // ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ =====
  window.checkEmailVerification = function() {
    if (auth.currentUser) {
      auth.currentUser.reload().then(() => {
        if (auth.currentUser.emailVerified) {
          clearInterval(verificationCheckInterval);
          verificationBox.classList.remove('show');
          alert('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
          
          db.collection('users').doc(auth.currentUser.uid).update({
            emailVerified: true,
            online: true
          });
        } else {
          alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¨Ø¹Ø¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        }
      });
    }
  };

  // ===== Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ =====
  window.resendVerification = function() {
    if (auth.currentUser) {
      auth.currentUser.sendEmailVerification()
        .then(() => {
          alert('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
        })
        .catch(err => {
          alert('âŒ Ø®Ø·Ø£: ' + err.message);
        });
    }
  };

  // ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© =====
  function register() {
    const emailVal = email.value.trim();
    const passVal = password.value.trim();
    const userVal = username.value.trim();
    
    if (!emailVal || !passVal || !userVal) {
      alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
      return;
    }
    
    if (!validateEmail()) {
      alert('âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­');
      return;
    }
    
    if (passVal.length < 6) {
      alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
      return;
    }
    
    auth.createUserWithEmailAndPassword(emailVal, passVal)
      .then(res => {
        sendVerificationEmail();
        
        return db.collection('users').doc(res.user.uid).set({
          username: userVal,
          email: emailVal,
          online: false,
          emailVerified: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      })
      .then(() => {
        alert('âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.');
        email.value = '';
        password.value = '';
        username.value = '';
      })
      .catch(err => {
        if (err.code === 'auth/email-already-in-use') {
          alert('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„');
        } else {
          alert('âŒ Ø®Ø·Ø£: ' + err.message);
        }
      });
  }

  function login() {
    const emailVal = email.value.trim();
    const passVal = password.value.trim();
    
    if (!emailVal || !passVal) {
      alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
      return;
    }
    
    if (!validateEmail()) {
      alert('âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­');
      return;
    }
    
    auth.signInWithEmailAndPassword(emailVal, passVal)
      .then(result => {
        if (!result.user.emailVerified) {
          verificationBox.classList.add('show');
          startAutoVerificationCheck();
          alert('âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ø¹Ø¯. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...');
          auth.signOut();
        }
      })
      .catch(err => {
        if (err.code === 'auth/user-not-found') {
          alert('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ');
        } else if (err.code === 'auth/wrong-password') {
          alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        } else {
          alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + err.message);
        }
      });
  }

  function googleLogin() {
    auth.signInWithPopup(googleProvider)
      .then(result => {
        const email = result.user.email;
        const usernameFromEmail = email.split('@')[0];
        
        return db.collection('users').doc(result.user.uid).set({
          username: usernameFromEmail,
          email: email,
          online: true,
          emailVerified: true,
          lastLogin: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      })
      .catch(err => {
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google: ' + err.message);
      });
  }

  function logout() {
    if (auth.currentUser) {
      db.collection('users').doc(auth.currentUser.uid).update({ online: false })
        .finally(() => {
          auth.signOut();
          if (verificationCheckInterval) {
            clearInterval(verificationCheckInterval);
          }
        });
    }
  }

  // ===== ØªÙˆÙ„ÙŠØ¯ Ù„ÙˆÙ† ÙØ§ØªØ­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… =====
  function getUserColor(uid) {
    if (userColors[uid]) return userColors[uid];
    
    const colors = [
      'rgba(70, 130, 180, 0.25)',
      'rgba(60, 179, 113, 0.25)',
      'rgba(255, 140, 0, 0.25)',
      'rgba(138, 43, 226, 0.25)',
      'rgba(220, 20, 60, 0.25)',
      'rgba(0, 206, 209, 0.25)',
      'rgba(255, 105, 180, 0.25)',
      'rgba(154, 205, 50, 0.25)',
      'rgba(255, 215, 0, 0.25)',
      'rgba(176, 224, 230, 0.25)'
    ];
    
    const index = uid.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
    userColors[uid] = colors[index];
    return userColors[uid];
  }

  // ===== Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ =====
  auth.onAuthStateChanged(async (user) => {
    console.log('onAuthStateChanged', user?.email, user?.emailVerified);
    
    // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
    authDiv.style.display = 'none';
    chatDiv.style.display = 'none';
    privatePage.classList.remove('show');
    verificationBox.classList.remove('show');
    
    // Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù†Ø¸Ù‡Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    loader.classList.remove('hidden');
    
    try {
      if (user) {
        // ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        if (user.emailVerified) {
          // Ø¨Ø±ÙŠØ¯Ù‡ Ù…ÙÙØ¹Ù‘Ù„
          currentUser = user;
          
          // Ø¬Ù„Ø¨ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            currentUsername = userDoc.data().username;
          } else {
            currentUsername = user.email.split('@')[0];
            await db.collection('users').doc(user.uid).set({
              username: currentUsername,
              email: user.email,
              online: true,
              emailVerified: true
            });
          }
          
          // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
          await db.collection('users').doc(user.uid).update({ online: true });
          
          // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
          loadPublicMessages();
          loadOnlineUsers();
          
          // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
          setTimeout(() => {
            addImageUploadButtons();
          }, 500);
          
          // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
          chatDiv.style.display = 'flex';
          
        } else {
          // Ø¨Ø±ÙŠØ¯Ù‡ ØºÙŠØ± Ù…ÙÙØ¹Ù‘Ù„
          verificationBox.classList.add('show');
          startAutoVerificationCheck();
          // Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ­Ù‚Ù‚
          authDiv.style.display = 'flex';
        }
      } else {
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        // Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        authDiv.style.display = 'flex';
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', error);
      // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù†Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ­Ù„ Ø¢Ù…Ù†
      authDiv.style.display = 'flex';
    } finally {
      // ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©ØŒ Ù†Ø®ÙÙŠ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      loader.classList.add('hidden');
    }
  });

  // ===== ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† =====
  function loadOnlineUsers() {
    if (unsubscribeOnline) unsubscribeOnline();
    
    unsubscribeOnline = db.collection('users')
      .where('online', '==', true)
      .onSnapshot(snapshot => {
        let html = '';
        snapshot.forEach(doc => {
          const data = doc.data();
          if (doc.id !== currentUser?.uid) {
            html += `
              <div class="online-user" onclick="openPrivateChat('${doc.id}', '${escapeHtml(data.username)}')">
                <span class="status"></span>
                <span class="name">${escapeHtml(data.username)}</span>
              </div>
            `;
          }
        });
        
        onlineList.innerHTML = html || '<div style="text-align:center; padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØµÙ„ÙŠÙ† Ø¢Ø®Ø±ÙŠÙ†</div>';
      }, error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†:', error);
      });
  }

  // ===== ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© =====
  window.openPrivateChat = function(uid, username) {
    if (!currentUser) return;
    
    activePartner = { uid, username };
    privatePartnerName.textContent = username;
    privatePage.classList.add('show');
    onlinePanel.classList.remove('show');

    if (unsubscribePartner) unsubscribePartner();
    unsubscribePartner = db.collection('users').doc(uid)
      .onSnapshot(doc => {
        if (doc.exists) {
          const online = doc.data().online;
          privateStatus.textContent = online ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„';
          privateStatus.style.background = online ? 'rgba(0,200,0,0.3)' : 'rgba(200,0,0,0.3)';
        }
      });

    loadPrivateMessages(uid);
  };

  // ===== Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø®Ø§ØµØ© =====
  window.closePrivateChat = function() {
    activePartner = null;
    privatePage.classList.remove('show');
    
    if (unsubscribePrivate) {
      unsubscribePrivate();
      unsubscribePrivate = null;
    }
    if (unsubscribePartner) {
      unsubscribePartner();
      unsubscribePartner = null;
    }
  };

  // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ± =====
  function loadPublicMessages() {
    if (unsubscribePublic) unsubscribePublic();
    
    unsubscribePublic = db.collection('messages')
      .orderBy('createdAt', 'asc')
      .onSnapshot(snapshot => {
        messagesDiv.innerHTML = '';
        
        if (snapshot.empty) {
          messagesDiv.innerHTML = '<div style="color:white; text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯...</div>';
          return;
        }
        
        snapshot.forEach(doc => {
          const msg = doc.data();
          if (!msg.text && !msg.imageUrl) return;
          
          const div = document.createElement('div');
          div.className = 'msg';
          
          if (msg.uid === currentUser?.uid) {
            div.classList.add('own');
          } else {
            div.style.backgroundColor = getUserColor(msg.uid);
          }
          
          let time = '';
          if (msg.createdAt?.toDate) {
            try {
              const d = msg.createdAt.toDate();
              time = `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
            } catch(e) {
              time = '';
            }
          }
          
          let content = '';
          content += `<span class="sender">${escapeHtml(msg.username || 'Ù…Ø¬Ù‡ÙˆÙ„')}</span>`;
          
          if (msg.text) {
            content += `<span class="text">${escapeHtml(msg.text)}</span>`;
          }
          
          if (msg.imageUrl) {
            content += `<img src="${escapeHtml(msg.imageUrl)}" class="image-message" onclick="showFullImage('${escapeHtml(msg.imageUrl)}')">`;
          }
          
          content += `<span class="time">${time}</span>`;
          
          div.innerHTML = content;
          messagesDiv.appendChild(div);
        });
        
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø©:', error);
      });
  }

  // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ© Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ± =====
  function loadPrivateMessages(partnerUid) {
    if (unsubscribePrivate) unsubscribePrivate();
    
    const roomId = currentUser.uid < partnerUid 
      ? currentUser.uid + '_' + partnerUid 
      : partnerUid + '_' + currentUser.uid;
    
    unsubscribePrivate = db.collection('private_messages')
      .where('roomId', '==', roomId)
      .orderBy('createdAt', 'asc')
      .onSnapshot(snapshot => {
        privateMessages.innerHTML = '';
        
        if (snapshot.empty) {
          privateMessages.innerHTML = '<div style="color:white; text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯...</div>';
          return;
        }
        
        snapshot.forEach(doc => {
          const msg = doc.data();
          if (!msg.text && !msg.imageUrl) return;
          
          const div = document.createElement('div');
          div.className = `private-msg ${msg.uid === currentUser.uid ? 'own' : ''}`;
          
          let time = '';
          if (msg.createdAt?.toDate) {
            try {
              const d = msg.createdAt.toDate();
              time = `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
            } catch(e) {
              time = '';
            }
          }
          
          let content = '';
          content += `<span class="sender">${escapeHtml(msg.username || 'Ù…Ø¬Ù‡ÙˆÙ„')}</span>`;
          
          if (msg.text) {
            content += `<span class="text">${escapeHtml(msg.text)}</span>`;
          }
          
          if (msg.imageUrl) {
            content += `<img src="${escapeHtml(msg.imageUrl)}" class="image-message" onclick="showFullImage('${escapeHtml(msg.imageUrl)}')">`;
          }
          
          content += `<span class="time">${time}</span>`;
          
          div.innerHTML = content;
          privateMessages.appendChild(div);
        });
        
        privateMessages.scrollTop = privateMessages.scrollHeight;
      }, error => {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©:', error);
        privateMessages.innerHTML = '<div style="color:red; text-align:center; padding:20px;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>';
      });
  }

  // ===== Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¹Ø§Ù…Ø© =====
  window.sendPublicMessage = function() {
    if (!currentUser) return;
    
    const text = messageInput.value.trim();
    if (!text) return;
    
    db.collection('messages').add({
      text: text,
      username: currentUsername,
      uid: currentUser.uid,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(err => {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©:', err);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + err.message);
    });
    
    messageInput.value = '';
  };

  // ===== Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© =====
  window.sendPrivateMessage = function() {
    if (!currentUser || !activePartner) {
      alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ø´Ø·Ø©');
      return;
    }
    
    const text = privateInput.value.trim();
    if (!text) return;
    
    const roomId = currentUser.uid < activePartner.uid 
      ? currentUser.uid + '_' + activePartner.uid 
      : activePartner.uid + '_' + currentUser.uid;
    
    db.collection('private_messages').add({
      text: text,
      username: currentUsername,
      uid: currentUser.uid,
      toUid: activePartner.uid,
      roomId: roomId,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).catch(err => {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', err);
      alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + err.message);
    });
    
    privateInput.value = '';
  };

  // ========== Ø¯ÙˆØ§Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Cloudinary ==========
  
  // Ø¯Ø§Ù„Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Cloudinary
  async function uploadImageToCloudinary(file) {
    if (!file) return null;
    
    if (file.size > 2 * 1024 * 1024) {
      alert("âŒ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª");
      return null;
    }
    
    if (!file.type.startsWith('image/')) {
      alert("âŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ ØµÙˆØ±Ø©");
      return null;
    }

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
        method: "POST",
        body: formData
      });

      if (!res.ok) {
        throw new Error('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
      }

      const data = await res.json();
      return data.secure_url;
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:', error);
      alert('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
      return null;
    }
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
  function addImageUploadButtons() {
    // Ø²Ø± Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
    const publicContainer = document.getElementById('imageUploadContainer');
    publicContainer.innerHTML = '';
    
    const publicUploadBtn = document.createElement('button');
    publicUploadBtn.className = 'image-upload-btn';
    publicUploadBtn.innerHTML = 'ğŸ“·';
    publicUploadBtn.type = 'button';
    publicUploadBtn.onclick = () => {
      currentImageMessageContext = 'public';
      document.getElementById('imageFileInput').click();
    };
    publicContainer.appendChild(publicUploadBtn);
    
    // Ø²Ø± Ù„Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ©
    const privateContainer = document.getElementById('privateImageUploadContainer');
    if (privateContainer) {
      privateContainer.innerHTML = '';
      
      const privateUploadBtn = document.createElement('button');
      privateUploadBtn.className = 'image-upload-btn';
      privateUploadBtn.innerHTML = 'ğŸ“·';
      privateUploadBtn.type = 'button';
      privateUploadBtn.onclick = () => {
        if (!activePartner) {
          alert('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© Ù†Ø´Ø·Ø©');
          return;
        }
        currentImageMessageContext = 'private';
        document.getElementById('imageFileInput').click();
      };
      privateContainer.appendChild(privateUploadBtn);
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ input file Ù…Ø®ÙÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (!document.getElementById('imageFileInput')) {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.id = 'imageFileInput';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      fileInput.onchange = handleImageSelect;
      document.body.appendChild(fileInput);
    }
  }
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø©
  window.handleImageSelect = function(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    selectedImageFile = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      imagePreviewUrl = e.target.result;
      document.getElementById('imagePreview').src = imagePreviewUrl;
      document.getElementById('imagePreviewContainer').classList.add('show');
    };
    reader.readAsDataURL(file);
  };
  
  // Ø¥Ù„ØºØ§Ø¡ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
  window.cancelImageUpload = function() {
    selectedImageFile = null;
    imagePreviewUrl = null;
    document.getElementById('imagePreviewContainer').classList.remove('show');
    document.getElementById('imageFileInput').value = '';
  };
  
  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØ±Ø©
  window.sendImageMessage = async function() {
    if (!selectedImageFile || !currentUser) {
      cancelImageUpload();
      return;
    }
    
    const progressDiv = document.getElementById('uploadProgress');
    progressDiv.classList.add('show');
    
    try {
      const imageUrl = await uploadImageToCloudinary(selectedImageFile);
      
      progressDiv.classList.remove('show');
      
      if (!imageUrl) {
        cancelImageUpload();
        return;
      }
      
      if (currentImageMessageContext === 'private' && activePartner) {
        const roomId = currentUser.uid < activePartner.uid 
          ? currentUser.uid + '_' + activePartner.uid 
          : activePartner.uid + '_' + currentUser.uid;
        
        await db.collection('private_messages').add({
          text: '',
          username: currentUsername,
          uid: currentUser.uid,
          toUid: activePartner.uid,
          roomId: roomId,
          imageUrl: imageUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await db.collection('messages').add({
          text: '',
          username: currentUsername,
          uid: currentUser.uid,
          imageUrl: imageUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      
      console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©:', error);
      alert('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
    } finally {
      progressDiv.classList.remove('show');
      cancelImageUpload();
    }
  };
  
  // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
  window.showFullImage = function(imageUrl) {
    document.getElementById('fullImage').src = imageUrl;
    document.getElementById('fullImageModal').classList.add('show');
  };

  // ===== Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† =====
  window.toggleOnlinePanel = function() {
    onlinePanel.classList.toggle('show');
  };

  // ===== Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ± =====
  messageInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendPublicMessage();
  });
  
  privateInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendPrivateMessage();
  });

  function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  document.addEventListener('click', (e) => {
    if (!onlinePanel.contains(e.target) && !e.target.classList.contains('online-btn')) {
      onlinePanel.classList.remove('show');
    }
  });

  // Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙƒØ¨Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
  document.getElementById('fullImageModal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.classList.remove('show');
    }
  });
</script>
</body>
  </html>
